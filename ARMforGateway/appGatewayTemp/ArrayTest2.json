{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
          "appgwName": {
              "type": "String",
              "metadata":{
              "description": "AppGateway name"
            }
          },
  
          "subcriptionID": {
            "type": "string",
            "defaultValue": "a77d2c8a-b7ca-4493-8046-38f707c7cd6f"
          },
  
          "resourceGroupName": {
            "type": "string",
            "metadata":{
              "description": "input resourceGroupName"
            }
          },
  
          "vnetName": {
            "type": "string",
            "metadata":{
              "description": "Virtual Network Name"
            }
          },
  
          "subIpname": {
            "type": "string",
            "metadata":{
              "description": "name for fully dedicated subnet"
            }
          },
          
          "pubIPname": {
            "type": "string",
            "metadata":{
              "description": "name of PublicIP"
            }
          },
  
          "gatewayIPConfigurations": {
            "type": "string",
            "metadata":{
              "description": "name value for gatewayIPConfigurations"
            }
          },
  
          "backendAddressPools": {
            "type": "string",
            "metadata":{
              "description": "name value for backendAddressPools"
            }
          },
  
          "httpListeners": {
            "type": "string",
            "metadata":{
              "description": "name value for HTTP Listener"
            }
          },
  
          "frontendIPConfigurations": {
            "type": "string",
            "metadata":{
              "description": "name value for frontendIPConfigurations"
            }
          },
  
          "requestRoutingRules": {
            "type": "string",
            "metadata":{
              "description": "name value for routing Rule"
            }
          },
         
          "poolIP": {
            "type": "String",
            "defaultValue": "10.0.0.20,10.0.0.21",
            "metadata":{
              "description": "Ip's for backend pool address"
            }
          },
        
  
          "backendHttpSettingsCollection": {
            "type": "string",
            "metadata":{
              "description": "Backend setting Name"
            }
          },
  
          "urlPathMap":{
            "type": "string",
            "metadata":{
              "description": "name value for URL Path config"
            }
          },
  
          "pathRuleName": {
            "type": "string",
            "metadata":{
              "description": "name value for path rule"
            }
          }       
      },
  
  
      "variables": {
        "networkApiVersion": "2022-01-01",


        "ips" : "[split(parameters('poolIP'), ',')]",

         "copy": [
                {
                "name": "myip",
                "count": "[length(variables('ips'))]",
                "input": {
                    "ipAddress": "[variables('ips')[copyIndex('myip')]]"
                }
              }
            ],


        "myips":"[variables('myip')]",



         "pubIPfront" : "[resourceId('Microsoft.Network/publicIPAddresses', parameters('pubIPname'))]",
         "vNet": "[concat(concat('/subscriptions/', parameters('subcriptionID'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.Network/virtualNetworks/', parameters('vnetName')))]",
         "subID" : "[concat(variables('vNet'),'/subnets/', parameters('subIpname'))]",
         "appGwId": "[resourceId('Microsoft.Network/applicationGateways', parameters('appgwName'))]",
         "urlPath": "[concat(variables('appGwId'),'/urlPathMaps/', parameters('urlPathMap'))]",
         "pathRules": "[concat(variables('urlPath'), '/pathRules/', parameters('pathRuleName'))]",
  
          "appGwSize": "Standard_v2",
          "appGwTier": "Standard_v2",
          "appGwFePort": 80,
          "appGwFeProtocol": "Http",
          "appGwBePort": 80,
          "appGwBEProtocol": "Http"
          },
  
    "resources": [
      {
        "type": "Microsoft.Network/applicationGateways",
        "location": "[resourceGroup().location]",
        "apiVersion": "[variables('networkApiVersion')]",
        "name": "[parameters('appgwName')]",
        "tags": {
          "Group": "Monitoring"
        },
    
  
        "properties": {
          "sku": {
              "name": "[variables('appGwSize')]",
              "tier": "[variables('appGwTier')]"
            },
  
          "autoscaleConfiguration": {
            "maxCapacity": 10,
            "minCapacity": 0
          },
  
  
  
          "gatewayIPConfigurations": [
                {
                "name": "[parameters('gatewayIPConfigurations')]",
                "properties": {
                "subnet": {
                  "id": "[concat(variables('subID'))]"
                }
              }
          }
          ],
          
          "backendAddressPools": [
          {
            "name": "[parameters('backendAddressPools')]",
            "properties": {
                "backendAddresses": "[variables('myips')]"
                }
              }
            ],
          
           "backendHttpSettingsCollection": [
             {
            "name": "[parameters('backendHttpSettingsCollection')]",
            "properties": {
                 "port": "[variables('appGwBePort')]",
                 "protocol": "[variables('appGwBeProtocol')]",
                "cookieBasedAffinity": "Disabled",
                 "pickHostNameFromBackendAddress": true,
                 "requestTimeout": 20
               }
               
             }
            ],
          
          "frontendIPConfigurations": [
            {
             "name": "[parameters('frontendIPConfigurations')]",
             "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress":{
                "id": "[concat(variables('pubIPfront'))]"
              }
  
             }
            }
          ],
          "frontendPorts": [
            {
              "name": "frontendPort",
              "properties": {
                "port": "[variables('appGwFePort')]"
              }
            }
          ],
  
          "httpListeners": [
            {
              "name": "[parameters('httpListeners')]",
              "properties": {
                "frontendIPConfiguration": {
                  "id": "[concat(concat(variables('appGwId')), '/frontendIPConfigurations/', parameters('frontendIPConfigurations'))]"
                },
  
                "frontendPort": {
                  "id": "[concat(variables('appGwId'), '/frontendPorts/frontendPort')]"
                },
  
                "Protocol": "[variables('appGwFeProtocol')]"
              }
            }
          ],




          "probes": [           
              "myProbe" 
          ],


          
          
      
          "requestRoutingRules": [
              {
               "Name": "[parameters('requestRoutingRules')]",
               "id" : "[concat(variables('appGwId'), '/requestRoutingRules/', parameters('requestRoutingRules'))]",
               "properties": {
                "priority": 1,
               "RuleType": "PathBasedRouting",
              "httpListener": {
                   "id": "[concat(variables('appGwId'), '/httpListeners/', parameters('httpListeners'))]"
                   },
              "urlPathMap": {
              "id": "[concat(variables('urlPath'))]"
               }
              }
            }
          ],
  
  
        "urlPathMaps": [
            {             
              "name": "[parameters('urlPathMap')]",
              "id": "[concat(variables('urlPath'))]",
              "properties": {
                "defaultBackendAddressPool": {
                  "id": "[concat(variables('appGwId'), '/backendAddressPools/', parameters('backendAddressPools'))]"
                  },
                "defaultBackendHttpSettings": {
                "id": "[concat(variables('appGwId'), '/backendHttpSettingsCollection/', parameters('backendHttpSettingsCollection'))]"
                },
              "pathRules": [
                {
                  "name": "[parameters('pathRuleName')]",
                  "id":"[variables('pathRules')]",
                  "properties": {
                    "paths": [
                      "/above"
                      ],
                      "backendAddressPool": {
                        "id": "[concat(variables('appGwId'), '/backendAddressPools/', parameters('backendAddressPools'))]"
                        },
                        "backendHttpSettings": {
                          "id": "[concat(variables('appGwId'), '/backendHttpSettingsCollection/', parameters('backendHttpSettingsCollection'))]"
                          }
                        }
                      }
                    ],
                 "requestRoutingRules": [
                  {
                  "id": "[concat(variables('appGwId'), '/requestRoutingRules/', parameters('requestRoutingRules'))]"
                  }]
                  }
                }
              ]
        }
      }
    ]
  }
